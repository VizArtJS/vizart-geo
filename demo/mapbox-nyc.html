<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=default"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/crossfilter.js"></script>
    <script src="lib/chroma.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet' />
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
    #menu {
        position: absolute;
        background: #fff;
        padding: 10px;
        font-family: 'Open Sans', sans-serif;
    }
</style>

<div id='map'></div>
<div id='menu'>
    <input id='basic' type='radio' name='rtoggle' value='basic' checked='checked'>
    <label for='basic'>basic</label>
    <input id='streets' type='radio' name='rtoggle' value='streets'>
    <label for='streets'>streets</label>
    <input id='bright' type='radio' name='rtoggle' value='bright'>
    <label for='bright'>bright</label>
    <input id='light' type='radio' name='rtoggle' value='light'>
    <label for='light'>light</label>
    <input id='dark' type='radio' name='rtoggle' value='dark'>
    <label for='dark'>dark</label>
    <input id='satellite' type='radio' name='rtoggle' value='satellite'>
    <label for='satellite'>satellite</label>
</div>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmlnZmF0ZG9nIiwiYSI6ImM1ZWIyYzYzMzkyM2JlMTc0M2VjNmRlOTk5NDdkN2VjIn0.DoyA-reichUjF_FO9dkazQ';
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v9',
        zoom: 11,
        pitch: 40,
        minZoom: 3,
        maxZoom: 18,
        center: [-74.0059, 40.7128],
    });

    var layerList = document.getElementById('menu');
    var inputs = layerList.getElementsByTagName('input');

    function switchLayer(layer) {
        var layerId = layer.target.id;
        map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
    }

    for (var i = 0; i < inputs.length; i++) {
        inputs[i].onclick = switchLayer;
    }




        map.on('load', function() {

            d3.json('assets/nyc_pedcyc_collisions_161004.geojson', (res)=> {
                let _all = crossfilter(res.features);

//                let _color = d3.scaleSequential(d3.interpolateGnBu);
                let _color = d3.scaleLinear().range(['#addd8e','#31a354']);
                let _dim = _all.dimension((d) => {
                    return d.properties.CYC_INJ;
                });

                let _s = _dim.bottom(1)[0].properties.CYC_INJ;
                let _t = _dim.top(1)[0].properties.CYC_INJ;

                _color.domain([_s, _t]);

                let radiusScale = d3.scaleLinear().domain([_s, _t]).range([1,18])

                let stops = [];
                for (let i = _s; i < _t + 1; i++) {
                    let _c = _color(i);
                    let _c2 = chroma(_c);
                    stops.push([i, _c2.hex()]);
                }

                let radiusStops = [];

                for (let i = _s; i < _t + 1; i++) {
                    let _r = radiusScale(i);
                    radiusStops.push([i, _r]);
                }

                map.addSource('veh-incidents', {
                    type: 'geojson',
                    data: res
                });

                map.addLayer({
                    'id': 'veh-incd',
                    'type': 'circle',
                    'source': 'veh-incidents',
                    'paint': {
                        'circle-color': {
                            property: 'CYC_INJ',
                            type: 'interval',
                            stops: stops
                        },
                        'circle-radius': {
                            property: 'CYC_INJ',
                            base: 3,
                            type: 'interval',
                            stops: radiusStops
                        },
                        'circle-opacity': 0.8,
                        'circle-blur': 0.5
                    },
                    'filter': ['>=', 'CYC_INJ', 1]
                }, 'waterway-label');

                map.addLayer({
                    'id': 'veh-incd-base',
                    'type': 'circle',
                    'source': 'veh-incidents',
                    'paint': {
                        'circle-color': 'yellow',
                        'circle-radius': 3,
                        'circle-opacity': 0.3,
                        'circle-blur': 1
                    },
                    'filter': ['<', 'CYC_INJ', 1]
                }, 'waterway-label');

                map.addLayer({
                    'id': '3d-buildings',
                    'source': 'composite',
                    'source-layer': 'building',
                    'filter': ['==', 'extrude', 'true'],
                    'type': 'fill-extrusion',
                    'minzoom': 15,
                    'paint': {
                        'fill-extrusion-color': '#03396c',
                        'fill-extrusion-height': {
                            'type': 'identity',
                            'property': 'height'
                        },
                        'fill-extrusion-base': {
                            'type': 'identity',
                            'property': 'min_height'
                        },
                        'fill-extrusion-opacity': .6
                    }
                });
            });

    });


</script>

</body>
</html>