<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'/>
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no'/>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=default"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="lib/d3.js"></script>
    <script src="lib/crossfilter.js"></script>
    <script src="lib/chroma.js"></script>
    <script src="lib/viewport.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src='//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js' charset='utf-8'></script>
    <script src="lib/d3-ForceEdgeBundling.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.38.0/mapbox-gl.css' rel='stylesheet'/>
</head>
<body>

<style>
    #menu {
        position: absolute;
        background: #fff;
        padding: 10px;
        font-family: 'Open Sans', sans-serif;
    }

    body {
        margin: 0;
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }

    #map {
        position: absolute;
        width: 100%;
        height: 100%;
    }

    canvas {
        position: absolute;
        width: 100%;
        height: 100%;
    }


</style>

<div id='map'></div>
<div id='menu'>
    <input id='basic' type='radio' name='rtoggle' value='basic' checked='checked'>
    <label for='basic'>basic</label>
    <input id='streets' type='radio' name='rtoggle' value='streets'>
    <label for='streets'>streets</label>
    <input id='bright' type='radio' name='rtoggle' value='bright'>
    <label for='bright'>bright</label>
    <input id='light' type='radio' name='rtoggle' value='light'>
    <label for='light'>light</label>
    <input id='dark' type='radio' name='rtoggle' value='dark'>
    <label for='dark'>dark</label>
    <input id='satellite' type='radio' name='rtoggle' value='satellite'>
    <label for='satellite'>satellite</label>
</div>

<script>
    $(function () {
        mapboxgl.accessToken = 'pk.eyJ1IjoiYmlnZmF0ZG9nIiwiYSI6ImM1ZWIyYzYzMzkyM2JlMTc0M2VjNmRlOTk5NDdkN2VjIn0.DoyA-reichUjF_FO9dkazQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v9',
            zoom: 3,
//            pitch: 40,
            maxZoom: 18,
            center: [-74.0059, 40.7128],
        });


        var bundlingWorker = new Worker("worker.js");
        var forceWorker = new Worker("worker2.js");

        //map.scrollZoom.disable()
        map.addControl(new mapboxgl.NavigationControl());

        var layerList = document.getElementById('menu');
        var inputs = layerList.getElementsByTagName('input');

        function switchLayer(layer) {
            var layerId = layer.target.id;
            map.setStyle('mapbox://styles/mapbox/' + layerId + '-v9');
        }

        for (var i = 0; i < inputs.length; i++) {
            inputs[i].onclick = switchLayer;
        }


        var points;
        var eedges = [];
        var nnodes = {};
        var _data = [];

        let _color = d3.scaleOrdinal().range(
            [
                        "#F44336",
                        "#E91E63",
                        "#9C27B0",
                        "#673AB7",
                        "#3F51B5",
                        "#2196F3",
                        "#03A9F4",
                        "#00BCD4",
                        "#009688",
                        "#4CAF50",
                        "#8BC34A",
                        "#CDDC39",
                        "#FFEB3B",
                        "#FFC107",
                        "#FF9800",
                        "#FF5722"
                    ]
        )

        let geoPoints = {
            "type": "FeatureCollection",
            "features": []
        }

        function getPointFeature(d) {
            return {
                "type": "Feature",
                "properties": {
                    id: d.id,
                    city: d.city,
                    airport: d.airport,
                    country: d.country,
                    "marker-color": d.color,
                    "marker-symbol": "rail-metro",
                    "line": "blue"
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [
                        d.longitude,
                        d.latitude
                    ]
                }
            };
        }

        function LineString(lon, lat, lon2, lat2) {
            return {
                "type": "Feature",
                "properties": { },
                "geometry": {
                    "type": "LineString",
                    "coordinates": [
                        [lon, lat],
                        [lon2, lat2]
                    ]
                }
            };
        }

        function drawPoints() {
            _data = _.values(nnodes);

            let _array = [];
            for (let d of _data) {
                _array.push(getPointFeature(d));
            }

            let geojson = {
                "type": "FeatureCollection",
                "features": _array
            }
            map.addSource('points', {
                type: 'geojson',
                data: geojson
            });

            let stops = [];


            for (let d of _color.domain()) {
                stops.push([d, _color(d)])
            }

            map.addLayer({
                'id': 'veh-incd',
                'type': 'circle',
                'source': 'points',
                'paint': {
                    'circle-color': {
                        property: 'country',
                        type: 'categorical',
                        stops:stops
                    },
                    'circle-radius': {
                        'base': 1.75,
                        'stops': [[12, 2], [22, 180]]
                    },
                    'circle-opacity': 0.8,
                    'circle-blur': 0.5
                },
            });
        }

        function drawLinks() {
            let _array = [];
            for (let d of eedges) {
                let _start = nnodes[d.source];
                let _end = nnodes[d.target];

                var _lineGeo = LineString(_start.longitude, _start.latitude, _end.longitude, _end.latitude)
                _lineGeo.properties.sourceCountry = _start.country
//                var lineDistance = turf.lineDistance(_lineGeo, 'kilometers');
//                var arc = [];
//
//                // Draw an arc between the `origin` & `destination` of the two points
//                for (var i = 0; i < lineDistance; i++) {
//                    var segment = turf.along(_lineGeo, i / 1000 * lineDistance, 'kilometers');
//                    arc.push(segment.geometry.coordinates);
//                }
//
//                _lineGeo.geometry.coordinates = arc;

                _array.push(_lineGeo);
            }

            let geojson = {
                "type": "FeatureCollection",
                "features": _array
            }
            map.addSource('links', {
                type: 'geojson',
                data: geojson
            });

            let stops = [];


            for (let d of _color.domain()) {
                stops.push([d, _color(d)])
            }
            map.addLayer({
                'id': 'veh-link',
                'type': 'line',
                'source': 'links',
                'paint': {
                    'line-color': {
                        property: 'sourceCountry',
                        type: 'categorical',
                        stops:stops
                    },
//                    'line-cap': 'round',
//                    'line-join': 'bevel',
                    'line-opacity': 0.1,
//                    'line-color': 'rgba(255, 0, 0, 0.415)',
                    'line-width': 1,
                    'line-blur': 0.5
                },
            });

//            map.setFilter('veh-link', ['==', 'sourceCountry', 'United States'])
        }


        map.on('load', function () {

            d3.json("assets/leaflet/flights.json", function (data) {

                for (let i = 0; i < data.airports.length; i++) {
                    let d = data.airports[i];
                    let lon = d[3];
                    let lat = d[4];
                    let p_ = [lon, lat];
//                    let proj = mapboxProjection(p_);
                    nnodes[i] = {
                        id: i,
                        airport: d[0],
                        city: d[1],
                        color: _color(d[2]),
                        country: d[2],
                        longitude: lon,
                        latitude: lat,
//                        x: proj[0],
//                        y:  proj[1],
                    };
                }


                for (var i = 0; i < data.routes.length; i++) {
                    eedges.push({
                        id: i,
                        'source': data.routes[i][1],
                        'target': data.routes[i][2]
                    });
                }

                drawPoints();
                drawLinks();
            });

        });


        function forceLinks() {
            forceWorker.terminate();
            forceWorker = new Worker('worker2.js');

            forceWorker.postMessage({
                nodes: nnodes,
                links: eedges
            });


            forceWorker.onmessage = function (event) {
                if (event.data.type === 'end') {
                    _context.beginPath();
                    _context.lineWidth = 1;
                    _context.strokeStyle = "rgba(255, 0, 0, 0.115)";
                    path.context(_context);
                    for (let d of event.data.links) {
//                        _context.moveTo(d.source.x, d.source.y);
//                        _context.lineTo(d.target.x, d.target.y);
                        _context.quadraticCurveTo(d.source.x, d.source.y, d.target.x, d.target.y);
//                        d3line([d.source, d.target]);

//                        let n =  { "type": "Feature",
//                            "geometry": {
//                                "type": "LineString",
//                                "coordinates": [[d.source.x, d.source.y], [d.target.x, d.target.y]]
//                            },
//                            "properties": {
//                            }
//                        };
//                        path(n);

                    }

                    _context.stroke();
                    _context.closePath();
                }
            };
        }

        function bundleLinks() {
            bundlingWorker.terminate();
            bundlingWorker = new Worker('worker.js');

            bundlingWorker.postMessage({
                nodes: nnodes,
                links: eedges
            });

            bundlingWorker.onmessage = function (event) {
                if (event.data.type === 'end') {
                    _context.beginPath();
                    _context.lineWidth = 1;
                    _context.strokeStyle = "rgba(255, 0, 0, 0.115)";

                    for (let d of event.data.links) {
                        d3line(d);
                    }

                    _context.stroke();
                    _context.closePath();
                }
            };
        }

//        function drawLinks() {
////            bundleLinks();
////            forceLinks();
//        }


        function onMove() {
            // we update our calculated projections whenever the underlying map changes
            // due to zoom and pan
            vp = getVP();
            d3Projection = getD3();

            for (let nn in nnodes) {
                let p_ = [nnodes[nn].longitude, nnodes[nn].latitude];
                let Proj = mapboxProjection(p_);

                nnodes[nn].x = Proj[0];
                nnodes[nn].y = Proj[1];
            }

            drawPoints();

            _canvas.selectAll('.edge')
                .attr('opacity', 0);
        }

        // re-render our visualization whenever the view changes
//        map.on("viewreset", function () {
//            drawLinks()
//        })
//        map.on("dragend", function () {
//            drawLinks()
//        })
//        map.on("pitchend", function () {
//            drawLinks()
//        })
//        map.on("rotateend", function () {
//            drawLinks()
//        })
//        map.on("zoomend", function () {
//            drawLinks()
//        })
//
//        map.on('move', function () {
//            onMove();
//        });


    })
</script>

</body>
</html>